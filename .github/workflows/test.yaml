name: Build and Upload JAR to JFrog

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build jar
        run: mvn clean package -DskipTests

      - name: Install JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4

      - name: Configure JFrog server
        run: |
          jfrog config add new-libs-snapshot-local \
            --url ${{ secrets.JF_URL }} \
            --user ${{ secrets.JF_USERNAME }} \
            --password ${{ secrets.JF_PASSWORD }} \
            --interactive=false

      - name: Upload to Maven Repo
        run: |
          jfrog mvn deploy \
            -s settings.xml \
            --server-id new-libs-snapshot-local \
            --repo-resolve new-libs-snapshot \
            --repo-deploy new-libs-snapshot-local \
            --build-name demo-build \
            --build-number $GITHUB_RUN_NUMBER

      - name: Xray Scan
        run: |
          jfrog xr scan . --server-id artifactory-server

