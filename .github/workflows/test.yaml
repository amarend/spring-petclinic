name: Build → Upload to Artifactory → Xray Scan
on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  build-upload-scan:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17
        
    - name: Install JFrog CLI
      uses: jfrog/setup-jfrog-cli@v3
      env:
        JF_URL: ${{ secrets.JF_URL }}
        JF_USER: ${{ secrets.JF_USERNAME }}
        JF_PASSWORD: ${{ secrets.JF_PASSWORD }}

    - name: Configure JFrog connection
      run: |
        jfrog config add new-libs-snapshot \
          --url="${{ secrets.JF_URL }}" \
          --user="${{ secrets.JF_USERNAME }}" \
          --password="${{ secrets.JF_PASSWORD }}" \
          --interactive=false
          
    - name: Build and Deploy using Maven
      run: |
        # Configure Maven to use Artifactory
        jfrog rt mvn-config \
          --server-id-resolve=new-libs-snapshot \
          --server-id-deploy=new-libs-snapshot \
          --repo-resolve-releases=new-libs-snapshot \
          --repo-resolve-snapshots=new-libs-snapshot \
          --repo-deploy-releases=new-libs-snapshot-local \
          --repo-deploy-snapshots=new-libs-snapshot-local
        
        # Build & deploy with build info
        jfrog rt mvn "clean deploy -DskipTests" \
          --build-name=petclinic-build \
          --build-number=${{ github.run_number }}
          
    - name: Collect Environment Variables
      run: |
        jfrog rt build-add-git petclinic-build ${{ github.run_number }}
          
    - name: Publish build-info to Artifactory
      run: |
        jfrog rt build-publish petclinic-build ${{ github.run_number }}
        
    - name: Wait for Xray Indexing (give it time to index)
      run: sleep 30
        
    - name: Xray Scan Build
      run: |
        jfrog rt build-scan petclinic-build ${{ github.run_number }} --fail=false
      continue-on-error: true
      
    - name: Xray Scan Build (Strict - Fail on Issues)
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        jfrog rt build-scan petclinic-build ${{ github.run_number }} --fail=true
